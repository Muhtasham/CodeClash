<!-- Trajectory Container with Overview and Messages -->
<div class="trajectory-header">
    <h3>
        <i class="bi bi-robot"></i> Player {{ trajectory.player_id }} Round {{ round_num }}
    </h3>
    <div class="trajectory-stats">
        <div class="stat-item">
            <span class="stat-label">API Calls:</span>
            <span class="stat-value">{{ trajectory.api_calls }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cost:</span>
            <span class="stat-value">${{ "%.2f"|format(trajectory.cost) }}</span>
        </div>
        {% if trajectory.exit_status %}
        <div class="stat-item">
            <span class="stat-label">Exit Status:</span>
            <span class="stat-value status-{{ trajectory.exit_status.lower() }}">{{ trajectory.exit_status }}</span>
        </div>
        {% endif %}
        {% if trajectory.valid_submission is not none %}
        <div class="stat-item">
            <span class="stat-label">Valid Submission?</span>
            <span class="stat-value valid-{{ 'yes' if trajectory.valid_submission else 'no' }}">{{ trajectory.valid_submission }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Messages Foldout inside the same container -->
    <details class="trajectory-messages-foldout">
        <summary>
            <i class="bi bi-chat"></i> Trajectory ({{ trajectory.messages|length }} total)
            {% if trajectory.trajectory_file_path %}
            <button class="copy-path-btn-small" data-path="{{ trajectory.trajectory_file_path }}" title="Copy trajectory file path">
                <i class="bi bi-clipboard"></i> Copy path
            </button>
            <button class="download-btn-small" data-path="{{ trajectory.trajectory_file_path }}" title="Download trajectory file">
                <i class="bi bi-download"></i> Download
            </button>
            {% endif %}
        </summary>
        <div class="trajectory-content">
            <div class="messages-container">
                {% for message in trajectory.messages %}
            <div class="message-block {{ message.role }}">
                <span class="message-role-badge">{{ message.role.title() }} #{{ loop.index }}</span>
                <div class="message-content">
                    {% if message.content is string %}
                        {% set content_lines = message.content.split('\n') %}
                        {% if content_lines|length <= 5 %}
                            <!-- Show full content if 5 lines or less -->
                            <div class="message-content-full">
                                    {% if message.role == 'assistant' and '```' in message.content %}
                                        <!-- Special handling for assistant messages with code blocks -->
                                        {% set parts = message.content.split('```') %}
                                        {% for part in parts %}
                                            {% if loop.index is odd %}
                                                <!-- Text part -->
                                                <div class="message-text"><pre>{{ part | unescape_content }}</pre></div>
                                            {% else %}
                                                <!-- Code part -->
                                                <div class="code-block">
                                                    <pre><code>{{ part | unescape_content }}</code></pre>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <!-- Regular text content -->
                                        <div class="message-text">
                                            <pre>{{ message.content | unescape_content }}</pre>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                            <!-- Show preview with expand button -->
                            <div class="message-preview-short clickable-message"  title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                    <div class="message-text">
                                        <pre>{{ content_lines[:5] | join('\n') | unescape_content }}</pre>
                                    </div>
                                    <div class="expand-indicator">
                                        â–¼ {{ content_lines|length - 5 }} more lines
                                    </div>
                            </div>
                            <div class="message-content-full" style="display: none;" title="Content expanded - click collapse button below to hide">
                                    {% if message.role == 'assistant' and '```' in message.content %}
                                        <!-- Special handling for assistant messages with code blocks -->
                                        {% set parts = message.content.split('```') %}
                                        {% for part in parts %}
                                            {% if loop.index is odd %}
                                                <!-- Text part -->
                                                <div class="message-text"><pre>{{ part | unescape_content }}</pre></div>
                                            {% else %}
                                                <!-- Code part -->
                                                <div class="code-block">
                                                    <pre><code>{{ part | unescape_content }}</code></pre>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <!-- Regular text content -->
                                        <div class="message-text">
                                            <pre>{{ message.content | unescape_content }}</pre>
                                        </div>
                                    {% endif %}
                                    <div class="collapse-indicator clickable-message"  title="Click to collapse">
                                        â–² Click to collapse
                                    </div>
                                </div>
                            {% endif %}
                        {% elif message.content is iterable %}
                            <!-- Handle complex content (e.g., user messages with multiple parts) -->
                            <div class="message-content-full">
                                {% for content_part in message.content %}
                                    {% if content_part.type == 'text' %}
                                        {% set content_lines = content_part.text.split('\n') %}
                                        {% if content_lines|length <= 5 %}
                                            <div class="message-text">
                                                <pre>{{ content_part.text | unescape_content }}</pre>
                                            </div>
                                        {% else %}
                                            <div class="message-preview-short clickable-message"  title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                                <div class="message-text">
                                                    <pre>{{ content_lines[:5] | join('\n') | unescape_content }}</pre>
                                                </div>
                                                <div class="expand-indicator">
                                                    â–¼ {{ content_lines|length - 5 }} more lines
                                                </div>
                                            </div>
                                            <div class="message-content-expanded" style="display: none;" title="Content expanded - click collapse button below to hide">
                                                <div class="message-text">
                                                    <pre>{{ content_part.text | unescape_content }}</pre>
                                                </div>
                                                <div class="collapse-indicator clickable-message"  title="Click to collapse">
                                                    â–² Click to collapse
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="message-part">
                                            <strong>{{ content_part.type.title() }}:</strong>
                                            <pre>{{ content_part | tojson(indent=2) }}</pre>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Fallback for other content types -->
                            <div class="message-content-full">
                                <div class="message-text">
                                    <pre>{{ message.content | tojson(indent=2) }}</pre>
                                </div>
                            </div>
                    {% endif %}
                </div>
            </div>
                {% endfor %}
            </div>
            <div class="collapse-messages-button">
                <button class="btn-collapse-messages">
                    â–² Collapse Messages
                </button>
            </div>
        </div>
    </details>

    <!-- Diff Foldout inside the same container (lazy loaded) -->
    <details class="trajectory-messages-foldout trajectory-diffs-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-file-diff"></i> Diff (Full)</summary>
        <div class="trajectory-content">
            <div class="diff-load-placeholder">
                <button class="btn btn-primary load-diffs-btn"
                        data-player="{{ trajectory.player_id }}"
                        data-round="{{ trajectory.round_num }}">
                    <i class="bi bi-download"></i> Load Diff Data
                </button>
            </div>
            <div class="diff-loading-spinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading diff data...</span>
            </div>
            <div class="diff-content" style="display: none;">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </details>

    <!-- Incremental Diff Foldout inside the same container (lazy loaded) -->
    <details class="trajectory-messages-foldout trajectory-incremental-diffs-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-arrow-repeat"></i> Incremental Diff</summary>
        <div class="trajectory-content">
            <div class="incremental-diff-load-placeholder">
                <button class="btn btn-primary load-diffs-btn"
                        data-player="{{ trajectory.player_id }}"
                        data-round="{{ trajectory.round_num }}">
                    <i class="bi bi-download"></i> Load Diff Data
                </button>
            </div>
            <div class="incremental-diff-content" style="display: none;">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </details>

    <!-- Modified Files Foldout inside the same container (lazy loaded) -->
    <details class="trajectory-messages-foldout trajectory-modified-files-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-file-text"></i> Modified Files</summary>
        <div class="trajectory-content">
            <div class="modified-files-load-placeholder">
                <button class="btn btn-primary load-diffs-btn"
                        data-player="{{ trajectory.player_id }}"
                        data-round="{{ trajectory.round_num }}">
                    <i class="bi bi-download"></i> Load Diff Data
                </button>
            </div>
            <div class="modified-files-content" style="display: none;">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </details>


</div>


<!-- Submission -->
{% if trajectory.submission %}
<details class="foldout">
    <summary>ðŸ“¤ Player {{ trajectory.player_id }} Round {{ round_num }} - Submission</summary>
    <div class="log-content">
        <pre><code>{{ trajectory.submission }}</code></pre>
    </div>
</details>
{% endif %}

<!-- Memory -->
{% if trajectory.memory %}
<details class="foldout">
    <summary>ðŸ§  Player {{ trajectory.player_id }} Round {{ round_num }} - Memory</summary>
    <div class="log-content">
        <pre><code>{{ trajectory.memory }}</code></pre>
    </div>
</details>
{% endif %}
